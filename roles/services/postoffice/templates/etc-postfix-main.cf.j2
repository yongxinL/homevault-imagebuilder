###################################################################################################
### Base Settings ###
#####################

# Greet connecting clients with this banner
smtpd_banner = $myhostname ESMTP $mail_name

# Do not append domain part to incomplete addresses (this is the MUA's job)
append_dot_mydomain = no

# Uncomment the next line to generate "delayed mail" warnings
delay_warning_time = 4h

# will it be a permanent error or temporary
unknown_local_recipient_reject_code = 450

# how long to keep message on queue before return as failed.
# some have 3 days, I have 16 days as I am backup server for some people
# whom go on holiday with their server switched off.
maximal_queue_lifetime = 7d

# max and min time in seconds between retries if connection failed
minimal_backoff_time = 1000s
maximal_backoff_time = 8000s

# how long to wait when servers connect before receiving rest of data
smtp_helo_timeout = 60s

# how many address can be used in one message.
# effective stopper to mass spammers, accidental copy in whole address list
# but may restrict intentional mail shots.
smtpd_recipient_limit = 16

# how many error before back off.
smtpd_soft_error_limit = 3

# how many max errors before blocking it.
smtpd_hard_error_limit = 12

# general directory settings
queue_directory = /var/spool/postfix
command_directory = /usr/sbin
daemon_directory = /usr/lib/postfix
sendmail_path = /usr/sbin/sendmail
newaliases_path = /usr/bin/newaliases
mailq_path = /usr/bin/mailq
html_directory = no
sample_directory = no
readme_directory = no
biff = no

###################################################################################################
### Internet and domain names ###
######################
myhostname = {{ target_host_name }}.{{ target_host_domain }}
myorigin = localhost

###################################################################################################
### ESMTP TLS Settings ###
######################

# Certification Authority
smtpd_tls_CAfile = /etc/ssl/certs/ca-certificates.crt

# Public Certificate
smtpd_tls_cert_file = /etc/ssl/private/{{ target_host_domain }}.crt

# Private Key (without passphrase)
smtpd_tls_key_file = /etc/ssl/private/{{ target_host_domain }}.key

# Enable TLS (required to encrypt the plaintext SASL authentication)
smtpd_use_tls = yes
smtp_use_tls = yes

# Offers STARTTLS while TLS is not enabled
smtp_tls_note_starttls_offer = yes

# Accept AUTH without encryption
smtpd_tls_auth_only = no

# Enable TLS but does not require the client use TLS encryption
smtpd_tls_security_level = may

# Randomizer for key creation
tls_random_source = dev:/dev/urandom

# Server-side TLS activity logging (set to 2-4 for debugging)
smtpd_tls_loglevel = 4
smtpd_tls_received_header = yes

# Activate TLS Session Cache
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${queue_directory}/smtp_scache

# Server-side TLS session cache
smtpd_tls_session_cache_timeout = 3600s

# Performance tuning - Avoid Denial-Of-Service-Attacks
smtpd_client_new_tls_session_rate_limit = 10

# Diffie-Hellman Parameters for Perfect Forward Secrecy
# Can be created with:
# openssl dhparam -2 -out dh_512.pem 512
# openssl dhparam -2 -out dh_1024.pem 1024
smtpd_tls_dh512_param_file = /etc/ssl/private/dh_512.pem
smtpd_tls_dh1024_param_file = /etc/ssl/private/dh_1024.pem

###################################################################################################
### ESMTP SASL Settings ###
######################

# Enable SASL authentication (required for SMTP authentication)
smtpd_sasl_auth_enable = yes
 
# Enable SASL for Outlook-Clients as well
broken_sasl_auth_clients = yes

# The name of the Postfix SMTP server's local SASL authentication realm
smtpd_sasl_local_domain =

# SMTP server SASL security options
smtpd_sasl_security_options = noanonymous

# The SASL plug-in type that the Postfix SMTP server should use for authentication
smtpd_sasl_type = dovecot

# path to the SASL socket relative to postfix spool directory i.e. /var/spool/postfix
smtpd_sasl_path = private/auth

###################################################################################################
### local Transport ###
######################

# The alias database that are used for delivery
alias_database = hash:/etc/aliases
alias_maps = hash:/etc/aliases, ldap:/etc/postfix/ldap-aliases.cf

# The next-hop destination of non-local mail
relayhost =

# Trusted networks/hosts (these are allowed to relay without authentication)
mynetworks = 127.0.0.0/8

# Optional external command that the delivery agent should use for mailbox delivery
mailbox_command = /usr/lib/dovecot/deliver

# The maximal size of any individual mailbox.
mailbox_size_limit = 0

# The set of characters that can separate a user name from its extension
recipient_delimiter = +

# The network interface addresses that this mail system receives mail on.
inet_interfaces = all

# The internet protocols Postfix will attempt to use when making or accepting connections.
inet_protocols = all

# Process one mail at one time
dovecot_destination_recipient_limit = 1

###################################################################################################
### Transport maps ###
######################

# The default maximal number of parallel deliveries to the same destination
default_destination_concurrency_limit = 20

# Optional lookup tables with mapping from recipient address to
transport_maps = ldap:/etc/postfix/ldap-transport.cf

# The list of domains that are delivered via the local mail delivery transport
mydestination =
    $transport_maps,
    localhost,
    localhost.localdomain,
    $myhostname,
    localhost.$mydomain
    $mydomain

# Lookup tables with all names or addresses of local recipients
local_recipient_maps = $alias_maps

###################################################################################################
### Session Policies ###
########################

# Optional restrictions that the Postfix SMTP server applies in the context of client connection request
smtpd_client_restrictions=
        permit_mynetworks,
        permit

# Optional restrictions that the Postfix SMTP server applies in the context of client RCPT TO command
smtpd_recipient_restrictions=
        permit_sasl_authenticated,
        permit_mynetworks,
        reject_invalid_hostname,
        reject_non_fqdn_hostname,
        reject_non_fqdn_sender,
        reject_non_fqdn_recipient,
        reject_unknown_sender_domain,
        reject_unknown_recipient_domain,
        reject_unauth_pipelining,
        permit_auth_destination,
        reject_unauth_destination,
        reject

# Optional restrictions that the Postfix SMTP server applies in the context of the client MAIL FROM command
smtpd_sender_restrictions=
        reject_unknown_sender_domain,
        reject_unlisted_sender,
        permit

# Reject the request if the sender is the null address and there are multiple recipients
smtpd_data_restrictions =
    reject_unauth_pipelining
    reject_multi_recipient_bounce
    permit

# Require HELO
smtpd_helo_required = yes

###################################################################################################
### Virtual Transport ###
######################

# Optional lookup tables that alias specific mail addresses or domains to other local or remote address.
virtual_alias_maps = ldap:/etc/postfix/ldap-aliases.cf

# Optional lookup tables with all valid addresses in the domain that match $virtual_mailbox_domains
virtual_mailbox_maps = ldap:/etc/postfix/ldap-recipients.cf

# Specified list of domains, mail is delivered vai the $virtual_transport mail deliver transport.
virtual_mailbox_domains = $virtual_mailbox_maps

# Deliver mail for virtual recipients to Dovecot
virtual_transport = dovecot

###################################################################################################
### content filter ###
######################
#content_filter = smtp-amavis:[127.0.0.1]:10024

###################################################################################################
### for debug only ###
######################
# What mechanisms the Postfix SMTP client uses to look up a host's IP address
#smtp_host_lookup = native

# What mechanisms the Postfix LMTP client uses to look up a host's IP address
#lmtp_host_lookup = native

# Disable DNS lookup in the Postfix SMTP and LMTP clients
#disable_dns_lookups = yes

# Ignore DNS MX lookup that procedure no response
#ignore_mx_lookup_error = yes
